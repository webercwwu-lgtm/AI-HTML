<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="教室期末考監考系統 - 10節課版" />
    <meta property="og:description" content="專為監考老師設計的動態看板。整合10節課時段、鐘聲校對、注意事項輪播與考勤統計。" />
    <meta property="og:image" content="https://i.postimg.cc/tgNpbqkj/examtool.png" />
    <meta property="og:type" content="website" />

    <title>教室期末考監考系統 (10節課版)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .time-input-container { position: relative; }
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto;
        }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        /* 讓列表平滑滾動 */
        .schedule-list { scroll-behavior: smooth; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 圖示組件 ---
        const Icon = ({ children, size = 24, className = "", onClick, disabled }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={{ cursor: onClick && !disabled ? 'pointer' : 'default', opacity: disabled ? 0.3 : 1 }}>
                {children}
            </svg>
        );

        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path><path d="M3 3v9h9"></path></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const ArrowUp = (props) => <Icon {...props}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></Icon>;
        const ArrowDown = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></Icon>;

        const { useState, useEffect, useRef, useMemo } = React;

        // --- 設定視窗組件 ---
        const SettingsModal = ({ show, onClose, reminders, setReminders }) => {
            if (!show) return null;
            const handleReminderChange = (mode, index, val) => {
                const newReminders = {...reminders};
                newReminders[mode][index] = val;
                setReminders(newReminders);
            };
            const addReminder = (mode) => {
                const newReminders = {...reminders};
                newReminders[mode].push("新提醒");
                setReminders(newReminders);
            };
            const removeReminder = (mode, index) => {
                const newReminders = {...reminders};
                newReminders[mode].splice(index, 1);
                setReminders(newReminders);
            };
            const moveReminder = (mode, index, direction) => {
                const newReminders = {...reminders};
                const list = newReminders[mode];
                if (direction === -1 && index > 0) [list[index], list[index-1]] = [list[index-1], list[index]];
                else if (direction === 1 && index < list.length - 1) [list[index], list[index+1]] = [list[index+1], list[index]];
                setReminders(newReminders);
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-4xl h-3/4 overflow-y-auto rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-6 sticky top-0 bg-white z-10 border-b pb-2">
                            <h2 className="text-2xl font-bold">提醒內容設定</h2>
                            <button onClick={onClose} className="px-4 py-2 bg-slate-100 rounded-lg font-medium">關閉</button>
                        </div>
                        <div className="grid grid-cols-2 gap-8">
                            <div className="bg-red-50 p-4 rounded-xl">
                                <h3 className="font-bold text-red-600 mb-4 flex justify-between items-center">考試中提醒 <Plus onClick={() => addReminder('exam')} className="text-green-600"/></h3>
                                {reminders.exam.map((text, idx) => (
                                    <div key={idx} className="flex gap-2 mb-2 items-center bg-white p-2 rounded border">
                                        <input value={text} onChange={(e) => handleReminderChange('exam', idx, e.target.value)} className="flex-1 text-sm outline-none" />
                                        <Trash2 size={16} onClick={() => removeReminder('exam', idx)} className="text-slate-300 hover:text-red-500" />
                                    </div>
                                ))}
                            </div>
                            <div className="bg-green-50 p-4 rounded-xl">
                                <h3 className="font-bold text-green-600 mb-4 flex justify-between items-center">休息/下課提醒 <Plus onClick={() => addReminder('break')} className="text-green-600"/></h3>
                                {reminders.break.map((text, idx) => (
                                    <div key={idx} className="flex gap-2 mb-2 items-center bg-white p-2 rounded border">
                                        <input value={text} onChange={(e) => handleReminderChange('break', idx, e.target.value)} className="flex-1 text-sm outline-none" />
                                        <Trash2 size={16} onClick={() => removeReminder('break', idx)} className="text-slate-300 hover:text-red-500" />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ExamSystem = () => {
            const [now, setNow] = useState(new Date());
            const [showSettings, setShowSettings] = useState(false);

            // --- 1. 初始化 10 節課時段 ---
            const defaultSchedule = Array.from({ length: 10 }, (_, i) => ({
                id: i + 1,
                subject: `科目 ${i + 1}`,
                start: `${String(8 + i).padStart(2, '0')}:40`,
                end: `${String(9 + i).padStart(2, '0')}:20`,
                audio: null
            }));

            const [schedule, setSchedule] = useState(() => {
                const saved = localStorage.getItem('exam_schedule_v10');
                return saved ? JSON.parse(saved) : defaultSchedule;
            });

            const [attendance, setAttendance] = useState(() => {
                const saved = localStorage.getItem('exam_attendance_v10');
                return saved ? JSON.parse(saved) : { expected: '', actual: '', absent: '' };
            });

            const [reminders, setReminders] = useState(() => {
                const saved = localStorage.getItem('exam_reminders_v10');
                return saved ? JSON.parse(saved) : {
                    exam: ["考卷記得寫姓名", "有問題舉手問老師", "耐心細心小心", "寫完多檢查"],
                    break: ["準備下個科目文具", "提早上廁所喝水", "桌面淨空"]
                };
            });

            const [playingAudioId, setPlayingAudioId] = useState(null);
            const audioRefs = useRef({});

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('exam_schedule_v10', JSON.stringify(schedule));
                localStorage.setItem('exam_attendance_v10', JSON.stringify(attendance));
                localStorage.setItem('exam_reminders_v10', JSON.stringify(reminders));
            }, [schedule, attendance, reminders]);

            const dateString = useMemo(() => {
                const rocYear = now.getFullYear() - 1911;
                const month = now.getMonth() + 1;
                const date = now.getDate();
                const dayName = ['日', '一', '二', '三', '四', '五', '六'][now.getDay()];
                return `民國${rocYear}年${month}月${date}日 星期${dayName}`;
            }, [now]);

            const parseTime = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                const d = new Date(now);
                d.setHours(h, m, 0, 0);
                return d;
            };

            const currentStatus = useMemo(() => {
                const currentTime = now.getTime();
                for (let i = 0; i < schedule.length; i++) {
                    const start = parseTime(schedule[i].start).getTime();
                    const end = parseTime(schedule[i].end).getTime();
                    if (currentTime >= start && currentTime <= end) {
                        return { type: 'exam', slotIndex: i, timeLeft: end - currentTime, totalDuration: end - start };
                    }
                    if (i < schedule.length - 1) {
                        const nextStart = parseTime(schedule[i+1].start).getTime();
                        if (currentTime > end && currentTime < nextStart) {
                            return { type: 'break', nextSlotIndex: i + 1, timeLeft: nextStart - currentTime, totalDuration: nextStart - end };
                        }
                    }
                }
                return { type: 'idle' };
            }, [now, schedule]);

            const handleAudioUpload = (e, id) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setSchedule(prev => prev.map(item => item.id === id ? { ...item, audio: ev.target.result } : item));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const toggleAudio = (id) => {
                const audio = audioRefs.current[id];
                if (playingAudioId === id) { audio.pause(); setPlayingAudioId(null); }
                else {
                    if (playingAudioId && audioRefs.current[playingAudioId]) audioRefs.current[playingAudioId].pause();
                    audio.play(); setPlayingAudioId(id);
                }
            };

            // --- 進度條組件 ---
            const ProgressBar = () => {
                const { type, timeLeft, totalDuration } = currentStatus;
                if (type === 'idle') return <div className="h-full flex items-center justify-center text-slate-400 text-2xl font-bold bg-slate-50 rounded-2xl border-dashed border-2">非考試時段</div>;
                const percent = Math.max(0, Math.min(100, (timeLeft / totalDuration) * 100));
                const mins = Math.ceil(timeLeft / 60000);
                const color = percent < 20 ? 'bg-rose-500' : 'bg-emerald-500';
                return (
                    <div className="w-full h-full flex flex-col p-2">
                        <div className="flex-1 bg-slate-100 rounded-2xl overflow-hidden relative border shadow-inner">
                            <div className={`absolute left-0 h-full transition-all duration-1000 ${color}`} style={{ width: `${percent}%` }}></div>
                            <div className="absolute inset-0 flex items-center justify-center z-10">
                                <span className="text-3xl font-black bg-white/80 px-4 py-1 rounded-full shadow-sm">
                                    {type === 'exam' ? '考試中' : '休息'} - 剩餘 {mins} 分鐘
                                </span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="w-screen h-screen flex flex-col bg-slate-50">
                    <SettingsModal show={showSettings} onClose={() => setShowSettings(false)} reminders={reminders} setReminders={setReminders} />
                    
                    {/* 上方：時間與進度 */}
                    <div className="h-1/3 flex bg-slate-900 shadow-xl z-20">
                        <div className="w-1/3 flex flex-col items-center justify-center border-r border-slate-700 text-white">
                            <div className="text-[2vh] text-slate-400 mb-1">{dateString}</div>
                            <div className="text-[10vh] font-mono font-bold leading-none">
                                {now.toLocaleTimeString('zh-TW', { hour12: false })}
                            </div>
                        </div>
                        <div className="w-2/3 p-4 bg-white">
                            <ProgressBar />
                        </div>
                    </div>

                    {/* 下方：列表與提醒 */}
                    <div className="h-2/3 flex overflow-hidden">
                        {/* A區：10節課列表 (可滾動) */}
                        <div className="w-1/2 border-r bg-white flex flex-col relative">
                            <div className="flex-1 overflow-y-auto schedule-list p-2 space-y-2">
                                {schedule.map((item, index) => {
                                    const isActive = currentStatus.type === 'exam' && currentStatus.slotIndex === index;
                                    return (
                                        <div key={item.id} className={`flex items-center p-3 gap-3 rounded-xl border transition-all ${isActive ? 'bg-amber-100 border-amber-400 ring-2 ring-amber-200' : 'bg-white'}`}>
                                            <input value={item.subject} onChange={(e) => setSchedule(s => s.map(x => x.id===item.id?{...x, subject:e.target.value}:x))} className="w-24 font-bold text-lg bg-transparent border-none outline-none" />
                                            <div className="flex-1 flex gap-2 font-mono text-sm text-slate-500">
                                                <input type="time" value={item.start} onChange={(e) => setSchedule(s => s.map(x => x.id===item.id?{...x, start:e.target.value}:x))} className="bg-transparent"/>
                                                <span>~</span>
                                                <input type="time" value={item.end} onChange={(e) => setSchedule(s => s.map(x => x.id===item.id?{...x, end:e.target.value}:x))} className="bg-transparent"/>
                                            </div>
                                            <div className="flex gap-2">
                                                <input type="file" id={`audio-${item.id}`} className="hidden" onChange={(e) => handleAudioUpload(e, item.id)} />
                                                {item.audio ? (
                                                    <div className="flex gap-1">
                                                        <audio ref={el => audioRefs.current[item.id] = el} src={item.audio} onEnded={() => setPlayingAudioId(null)} />
                                                        <button onClick={() => toggleAudio(item.id)} className={`p-1 rounded-full text-white ${playingAudioId===item.id?'bg-rose-500':'bg-emerald-500'}`}>
                                                            {playingAudioId===item.id?<Pause size={18}/>:<Play size={18}/>}
                                                        </button>
                                                        <Trash2 size={18} className="text-slate-300" onClick={() => setSchedule(s => s.map(x => x.id===item.id?{...x, audio:null}:x))} />
                                                    </div>
                                                ) : <label htmlFor={`audio-${item.id}`} className="cursor-pointer text-slate-300"><Upload size={20}/></label>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* 考勤區 (縮小高度) */}
                            <div className="h-24 bg-slate-50 border-t flex p-2 gap-4">
                                <div className="flex-1 bg-white p-2 rounded border text-center shadow-sm">
                                    <div className="text-xs font-bold text-slate-400 uppercase">應到</div>
                                    <input value={attendance.expected} onChange={e => setAttendance({...attendance, expected:e.target.value})} className="w-full text-center text-2xl font-bold bg-transparent outline-none" />
                                </div>
                                <div className="flex-1 bg-white p-2 rounded border text-center shadow-sm">
                                    <div className="text-xs font-bold text-green-500 uppercase">實到</div>
                                    <input value={attendance.actual} onChange={e => setAttendance({...attendance, actual:e.target.value})} className="w-full text-center text-2xl font-bold bg-transparent outline-none" />
                                </div>
                                <div className="flex-[1.5] bg-white p-2 rounded border shadow-sm">
                                    <div className="text-xs font-bold text-red-500 text-center uppercase">缺席名單</div>
                                    <input value={attendance.absent} onChange={e => setAttendance({...attendance, absent:e.target.value})} className="w-full text-center text-sm bg-transparent outline-none mt-1" placeholder="座號/姓名" />
                                </div>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-400 self-center"><Settings /></button>
                            </div>
                        </div>

                        {/* B區：動態提醒 (保持大字體) */}
                        <div className="w-1/2 bg-[#fffdf0] flex flex-col items-center justify-center p-8 text-center">
                            <h2 className="text-2xl font-bold text-slate-400 mb-6 border-b pb-2 w-full">
                                {currentStatus.type === 'exam' ? '考試注意事項' : '下課注意事項'}
                            </h2>
                            <div className="text-[6vh] font-black text-slate-800 leading-tight">
                                {(() => {
                                    const list = currentStatus.type === 'exam' ? reminders.exam : reminders.break;
                                    const idx = Math.floor(now.getTime() / 5000) % (list.length || 1);
                                    return list[idx] || "保持安靜";
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamSystem />);
    </script>
</body>
</html>
