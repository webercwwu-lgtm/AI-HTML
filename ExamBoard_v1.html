<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸæœ«è€ƒçœ‹æ¿ç³»çµ± - 10ç§‘ç›®ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        .btn-active:active { transform: scale(0.95); }
        .track-transition { transition: stroke-dashoffset 1s linear, stroke 0.5s ease; }
        .bg-stripes {
            background-image: linear-gradient(45deg, #fbbf24 25%, transparent 25%, transparent 50%, #fbbf24 50%, #fbbf24 75%, transparent 75%, transparent);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. å®šç¾© 10 ç¯€èª²æ™‚é–“è¡¨ ---
        const SCHEDULE = [
            { type: 'exam',  start: '08:40', end: '09:20', label: 'ç¬¬ä¸€ç¯€' },
            { type: 'break', start: '09:20', end: '09:30', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '09:30', end: '10:10', label: 'ç¬¬äºŒç¯€' },
            { type: 'break', start: '10:10', end: '10:30', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '10:30', end: '11:10', label: 'ç¬¬ä¸‰ç¯€' },
            { type: 'break', start: '11:10', end: '11:20', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '11:20', end: '12:00', label: 'ç¬¬å››ç¯€' },
            { type: 'break', start: '12:00', end: '13:10', label: 'åˆä¼‘' },
            { type: 'exam',  start: '13:10', end: '13:50', label: 'ç¬¬äº”ç¯€' },
            { type: 'break', start: '13:50', end: '14:00', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '14:00', end: '14:40', label: 'ç¬¬å…­ç¯€' },
            { type: 'break', start: '14:40', end: '14:50', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '14:50', end: '15:30', label: 'ç¬¬ä¸ƒç¯€' },
            { type: 'break', start: '15:30', end: '15:40', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '15:40', end: '16:20', label: 'ç¬¬å…«ç¯€' },
            { type: 'break', start: '16:20', end: '16:30', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '16:30', end: '17:10', label: 'ç¬¬ä¹ç¯€' },
            { type: 'break', start: '17:10', end: '17:20', label: 'ä¸‹èª²' },
            { type: 'exam',  start: '17:20', end: '18:00', label: 'ç¬¬åç¯€' }
        ];

        const EXAM_SLOTS = SCHEDULE.filter(s => s.type === 'exam');
        const EXAM_MESSAGES = ["è€ƒå·è¨˜å¾—å¯«ç­ç´šå§“å", "æœ‰å•é¡Œèˆ‰æ‰‹å•è€å¸«", "è€å¿ƒã€ç´°å¿ƒã€å°å¿ƒ", "å¯«å®Œå¤šæª¢æŸ¥"];
        const BREAK_MESSAGES = ["ææ—©ä¸Šå»æ‰€å–æ°´", "æº–å‚™ä¸‹å€‹ç§‘ç›®", "æ¡Œé¢æ·¨ç©º"];

        const formatTime = (date) => {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            const s = String(date.getSeconds()).padStart(2, '0');
            return `${h}:${m}:${s}`;
        };

        const App = () => {
            const [now, setNow] = useState(new Date());
            const [offset, setOffset] = useState(() => parseInt(localStorage.getItem('exam_clock_offset') || 0));

            // åˆå§‹åŒ– 10 å€‹éŸ³è»Œ
            const [audioTracks, setAudioTracks] = useState(Array(10).fill(null).map(() => ({
                src: null, fileName: "", isPlaying: false, progress: 0
            })));
            
            const audioRefs = useRef([]);
            const fileInputRefs = useRef([]);

            // åˆå§‹åŒ– 10 å€‹ç§‘ç›®åç¨±
            const [examData, setExamData] = useState(() => {
                const saved = localStorage.getItem('exam_data_v10');
                return saved ? JSON.parse(saved) : {
                    subjects: Array(10).fill("").map((_, i) => `ç§‘ç›® ${i+1}`),
                    shouldArrive: "", actualArrive: "", absentList: ""
                };
            });

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('exam_clock_offset', offset);
                localStorage.setItem('exam_data_v10', JSON.stringify(examData));
            }, [offset, examData]);

            const adjustedNow = useMemo(() => new Date(now.getTime() + offset), [now, offset]);

            const currentSlot = useMemo(() => {
                const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;
                for (let slot of SCHEDULE) {
                    const [sh, sm] = slot.start.split(':').map(Number);
                    const [eh, em] = slot.end.split(':').map(Number);
                    const startMs = sh * 3600000 + sm * 60000;
                    const endMs = eh * 3600000 + em * 60000;
                    if (currentMs >= startMs && currentMs < endMs) {
                        return { ...slot, startMs, endMs, durationMs: endMs - startMs };
                    }
                }
                return null;
            }, [adjustedNow]);

            const progressInfo = useMemo(() => {
                if (!currentSlot) return { remainingPercent: 0, color: 'stroke-gray-300', text: 'ä¼‘æ¯æ™‚é–“' };
                const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;
                const progressMs = currentMs - currentSlot.startMs;
                const remainingPercent = 100 - (Math.min(100, (progressMs / currentSlot.durationMs) * 100));
                return { 
                    remainingPercent, 
                    color: currentSlot.type === 'exam' ? (remainingPercent < 20 ? 'stroke-red-500' : 'stroke-green-500') : 'stroke-blue-400', 
                    text: currentSlot.label 
                };
            }, [adjustedNow, currentSlot]);

            const handleSubjectChange = (index, value) => {
                const newSubjects = [...examData.subjects];
                newSubjects[index] = value;
                setExamData(prev => ({ ...prev, subjects: newSubjects }));
            };

            const togglePlay = (index) => {
                const audioEl = audioRefs.current[index];
                if (!audioEl) return;
                setAudioTracks(prev => {
                    const newTracks = [...prev];
                    if (!newTracks[index].isPlaying) {
                        newTracks.forEach((t, i) => { if(i!==index && t.isPlaying) audioRefs.current[i].pause(); t.isPlaying = false; });
                        audioEl.play();
                    } else { audioEl.pause(); }
                    newTracks[index].isPlaying = !newTracks[index].isPlaying;
                    return newTracks;
                });
            };

            return (
                <div className="flex flex-col h-screen w-screen overflow-hidden">
                    {/* ä¸Šæ–¹æ™‚é–“èˆ‡é€²åº¦ */}
                    <div className="h-[25vh] w-full bg-white border-b-4 flex shadow-lg">
                        <div className="w-1/3 flex flex-col items-center justify-center bg-gray-50 border-r">
                            <div className="text-[1.2vw] font-bold text-gray-500">ç¾åœ¨æ™‚é–“</div>
                            <div className="text-[5vw] font-black tabular-nums">{formatTime(adjustedNow)}</div>
                            <div className="flex gap-2">
                                <button onClick={() => setOffset(o => o - 60000)} className="px-2 py-1 bg-gray-200 rounded text-xs">-1åˆ†</button>
                                <button onClick={() => setOffset(o => o + 60000)} className="px-2 py-1 bg-gray-200 rounded text-xs">+1åˆ†</button>
                            </div>
                        </div>
                        <div className="w-2/3 flex items-center justify-center p-4 relative">
                            <span className="absolute text-[3vw] font-bold text-gray-400">{progressInfo.text}</span>
                            <svg className="w-full h-full" viewBox="0 0 300 60">
                                <rect x="10" y="10" width="280" height="40" rx="20" fill="none" stroke="#eee" strokeWidth="8"/>
                                <rect x="10" y="10" width="280" height="40" rx="20" fill="none" className={`track-transition ${progressInfo.color}`} strokeWidth="8" pathLength="100" strokeDasharray="100" strokeDashoffset={100 - progressInfo.remainingPercent} strokeLinecap="round"/>
                            </svg>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-row">
                        {/* Aå€ï¼š10å€‹ç§‘ç›®åˆ—è¡¨ */}
                        <div className="w-1/2 border-r-4 border-gray-300 flex flex-col bg-white">
                            <div className="flex-1 overflow-y-auto">
                                {EXAM_SLOTS.map((slot, index) => (
                                    <div key={index} className={`flex items-center px-4 py-1 border-b h-[10%] ${currentSlot?.start === slot.start ? 'bg-yellow-100' : ''}`}>
                                        <input 
                                            type="text" 
                                            value={examData.subjects[index]} 
                                            onChange={(e) => handleSubjectChange(index, e.target.value)}
                                            className="flex-1 text-[1.5vw] font-bold bg-transparent outline-none"
                                        />
                                        <div className="text-[1.5vw] font-mono mr-4">{slot.start}-{slot.end}</div>
                                        <div className="flex gap-1">
                                            <input type="file" accept="audio/*" className="hidden" ref={el => fileInputRefs.current[index] = el} onChange={(e) => {
                                                const file = e.target.files[0];
                                                if(file) setAudioTracks(prev => {
                                                    const n = [...prev];
                                                    n[index] = { ...n[index], src: URL.createObjectURL(file), fileName: file.name };
                                                    return n;
                                                });
                                            }}/>
                                            <button onClick={() => fileInputRefs.current[index].click()} className="p-1 bg-gray-100 rounded text-[1vw]">ğŸ“</button>
                                            {audioTracks[index].src && (
                                                <button onClick={() => togglePlay(index)} className={`px-2 py-1 rounded text-white text-[1vw] ${audioTracks[index].isPlaying ? 'bg-red-500' : 'bg-green-500'}`}>
                                                    {audioTracks[index].isPlaying ? 'æš«åœ' : 'æ’­æ”¾'}
                                                </button>
                                            )}
                                        </div>
                                        <audio ref={el => audioRefs.current[index] = el} src={audioTracks[index].src} onEnded={() => setAudioTracks(prev => { const n = [...prev]; n[index].isPlaying = false; return n; })} />
                                    </div>
                                ))}
                            </div>
                            <div className="h-[20%] bg-blue-50 flex border-t-2">
                                <div className="flex-1 flex flex-col items-center justify-center border-r">
                                    <span className="text-xs font-bold">æ‡‰åˆ°</span>
                                    <input type="number" value={examData.shouldArrive} onChange={e => setExamData({...examData, shouldArrive: e.target.value})} className="bg-transparent text-2xl font-bold w-full text-center outline-none"/>
                                </div>
                                <div className="flex-1 flex flex-col items-center justify-center border-r">
                                    <span className="text-xs font-bold text-green-700">å¯¦åˆ°</span>
                                    <input type="number" value={examData.actualArrive} onChange={e => setExamData({...examData, actualArrive: e.target.value})} className="bg-transparent text-2xl font-bold w-full text-center outline-none"/>
                                </div>
                                <div className="flex-[2] flex flex-col items-center justify-center">
                                    <span className="text-xs font-bold text-red-700">æœªåˆ°å§“å</span>
                                    <textarea value={examData.absentList} onChange={e => setExamData({...examData, absentList: e.target.value})} className="bg-transparent text-sm w-full text-center outline-none resize-none"/>
                                </div>
                            </div>
                        </div>

                        {/* Bå€ï¼šæé†’ */}
                        <div className="w-1/2 bg-[#fffdf0] flex flex-col items-center justify-center p-8 relative">
                            <div className="absolute top-0 left-0 bg-yellow-400 px-4 py-1 font-bold">æé†’äº‹é …</div>
                            <div className="text-[4vw] font-bold text-center leading-tight">
                                {currentSlot?.type === 'exam' ? EXAM_MESSAGES[Math.floor(Date.now()/5000)%EXAM_MESSAGES.length] : "æº–å‚™è€ƒè©¦ï¼Œæ”¶æ‹¾æ¡Œé¢"}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
